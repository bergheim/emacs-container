FROM alpine:3.21

# Skip Playwright's bundled glibc browser
ENV PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1
ENV PLAYWRIGHT_CHROMIUM_EXECUTABLE_PATH=/usr/bin/chromium-browser

# Install system dependencies
RUN apk add --no-cache \
    nodejs \
    npm \
    chromium \
    # Chromium dependencies
    nss \
    freetype \
    harfbuzz \
    ca-certificates \
    ttf-freefont \
    # glibc compat layer (for agent-browser binary)
    gcompat \
    # For test scripts
    jq \
    curl

# Create non-root user
RUN adduser -D -u 1000 tester
USER tester
WORKDIR /home/tester

# Install Playwright and agent-browser
RUN npm init -y && \
    npm install playwright agent-browser

# Copy test scripts and browser-check CLI
COPY --chown=tester:tester test-all.js browser-check.js test-context-reduction.sh ./

# Make browser-check available as a command
ENV PATH="/home/tester:$PATH"

CMD ["sh", "-c", "node test-all.js && echo '' && echo '=== Testing browser-check CLI ===' && node browser-check.js https://example.com --describe --console --errors --aria --interactive && echo '' && ./test-context-reduction.sh https://example.com"]
